name: Jira Automation

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  update-jira:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    timeout-minutes: 5  # Prevent workflow from running too long

    steps:
      - name: Check pull request information
        id: check-pr
        run: |
          echo "PR Title: ${{ github.event.pull_request.title }}"
          if [ -z "${{ github.event.pull_request.title }}" ]; then
            echo "WARNING: Pull request title is empty or undefined" 
            echo "HAS_TITLE=false" >> $GITHUB_ENV
          else
            echo "HAS_TITLE=true" >> $GITHUB_ENV
          fi

      - name: Login to Jira
        id: login
        uses: atlassian/gajira-login@master
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        timeout-minutes: 1

      - name: Extract issue key from PR title
        id: extract-key
        if: env.HAS_TITLE == 'true'
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          # Use grep to extract issue key pattern (e.g., SEG-123)
          ISSUE_KEY=$(echo "$PR_TITLE" | grep -o -E '[A-Z]+-[0-9]+' | head -n 1)
          if [ -n "$ISSUE_KEY" ]; then
            echo "ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV
            echo "Found issue key: $ISSUE_KEY"
          else
            echo "No issue key found in PR title"
          fi

      - name: Extract issue key from branch name (fallback)
        id: extract-key-branch
        if: env.HAS_TITLE == 'true' && !env.ISSUE_KEY
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          # Use grep to extract issue key pattern (e.g., SEG-123)
          ISSUE_KEY=$(echo "$BRANCH_NAME" | grep -o -E '[A-Z]+-[0-9]+' | head -n 1)
          if [ -n "$ISSUE_KEY" ]; then
            echo "ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV
            echo "Found issue key from branch: $ISSUE_KEY"
          else
            echo "No issue key found in branch name"
          fi

      - name: Check if issue key was found
        id: check-issue
        run: |
          if [ -n "$ISSUE_KEY" ]; then
            echo "ISSUE_FOUND=true" >> $GITHUB_ENV
            echo "Final Jira issue key: $ISSUE_KEY"
          else
            echo "ISSUE_FOUND=false" >> $GITHUB_ENV
            echo "::warning::No Jira issue key found in PR title or branch name"
          fi

      - name: Move Jira issue to Done
        id: transition
        if: env.ISSUE_FOUND == 'true'
        uses: atlassian/gajira-transition@master
        with:
          issue: ${{ env.ISSUE_KEY }}
          transition: Done
        timeout-minutes: 1

      - name: Verify transition success
        if: env.ISSUE_FOUND == 'true'
        run: |
          if [ "${{ steps.transition.outcome }}" == "success" ]; then
            echo "Successfully moved ${{ env.ISSUE_KEY }} to Done status"
          else
            echo "::error::Failed to transition ${{ env.ISSUE_KEY }} to Done status"
            exit 1
          fi